<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Gene Expression FITB Quiz</title>

    <!-- React + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      input[type="text"] {
        outline: none;
      }
    </style>
  </head>
  <body class="bg-slate-100 min-h-screen flex items-center justify-center">
    <div id="root"></div>

    <script type="text/babel">
      // ---------------------- LENIENT MATCH HELPERS (copied from launcher) ----------------------
      const STOP = new Set(["a","an","the","of","to","and","for","in","on","at","is"]);
      const IRREG = new Map([
        ["children","child"],["mice","mouse"],["men","man"],["women","woman"],
        ["teeth","tooth"],["feet","foot"],["geese","goose"],
        ["nuclei","nucleus"],["bacteria","bacterium"],["data","datum"],
        ["media","medium"],["criteria","criterion"],["indices","index"],
        ["matrices","matrix"],["codices","codex"],["lives","life"],["leaves","leaf"]
      ]);

      const norm = (s) =>
        String(s == null ? "" : s)
          .toLowerCase()
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")          // strip accents
          .replace(/[‐-‒–—―]/g, "-")                 // unify dashes
          .replace(/β/g, "beta")
          .replace(/α/g, "alpha")
          .replace(/γ/g, "gamma")
          .replace(/μ/g, "micro")
          .replace(/ß/g, "ss")
          .replace(/[^a-z0-9\s\-+\/.%]/g, " ")
          .replace(/\s+/g, " ")
          .trim();

      const singularize = (w) => {
        if (IRREG.has(w)) return IRREG.get(w);
        if (w.endsWith("ies") && w.length > 3) return w.slice(0,-3)+"y";
        if (/(ches|shes|xes|zes)$/.test(w)) return w.slice(0,-2);
        if (/ves$/.test(w)) return w.slice(0,-3)+(w.endsWith("ves")? (w.slice(-4,-3)==="i"?"fe":"f") : "f");
        if (w.endsWith("es") && !w.endsWith("ses") && !/(ches|shes|xes|zes)$/.test(w)) return w.slice(0,-2);
        if (w.endsWith("s") && !w.endsWith("ss")) return w.slice(0,-1);
        return w;
      };

      const baseForm = (s) =>
        norm(s)
          .replace(/[-_]/g, " ")
          .split(" ")
          .filter(Boolean)
          .map((w) => singularize(w))
          .join(" ");

      const tokens = (s) =>
        baseForm(s)
          .split(" ")
          .filter((w) => w && !STOP.has(w));

      // Levenshtein distance
      const lev = (a, b) => {
        a = baseForm(a); b = baseForm(b);
        if (a === b) return 0;
        const m = a.length, n = b.length;
        if (!m) return n; if (!n) return m;
        const v0 = new Array(n + 1), v1 = new Array(n + 1);
        for (let i = 0; i <= n; i++) v0[i] = i;
        for (let i = 0; i < m; i++) {
          v1[0] = i + 1;
          for (let j = 0; j < n; j++) {
            const cost = a[i] === b[j] ? 0 : 1;
            v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
          }
          for (let j = 0; j <= n; j++) v0[j] = v1[j];
        }
        return v0[n];
      };

      // Very lenient equality
      const eqLoose = (a, b) => {
        const na = norm(a), nb = norm(b);
        if (na === nb) return true;

        const ta = tokens(na), tb = tokens(nb);
        if (ta.length && tb.length) {
          // unordered token match tolerance
          const setB = new Set(tb);
          let inter = 0;
          for (let t of ta) if (setB.has(t)) inter++;
          const unionSize = new Set([...ta, ...tb]).size;
          const jacc = inter / Math.max(1, unionSize);
          if (jacc >= 0.75) return true;

          // allow subset if one side is short (e.g., "codon" vs "the codons")
          if (Math.min(ta.length, tb.length) <= 2) {
            const short = ta.length <= tb.length ? ta : tb;
            const longSet = new Set(ta.length <= tb.length ? tb : ta);
            if (short.every((w) => longSet.has(w))) return true;
          }
        }

        // char-level typo tolerance scaled by length
        const d = lev(na, nb);
        const L = Math.max(na.length, nb.length);
        const thresh = Math.max(1, Math.min(4, Math.round(L * 0.22))); // up to ~22% typos, cap 4
        return d <= thresh;
      };

      // Small helper for this file
      const matchFITB = (userInput, acceptableAnswers) =>
        acceptableAnswers.some((a) => eqLoose(a, userInput));

      // ---------------------- QUESTIONS ----------------------
      const QUESTIONS = [
        {
          id: 1,
          label: "1",
          prompt:
            "Label 1: In the cytoplasm, an extracellular ______ triggers a pathway that can regulate gene expression in the nucleus.",
          answers: ["signal", "signaling molecule", "signalling molecule"],
          imageSrc: "images/eukaryote transcription and translation.png",
        },
        {
          id: 2,
          label: "2",
          prompt:
            "Label 2: Chromatin modification such as ______ of histones can loosen chromatin and make DNA more available for transcription.",
          answers: ["acetylation", "histone acetylation", "acetylation of histones"],
          imageSrc: "images/eukaryote transcription and translation.png",
        },
        {
          id: 3,
          label: "3",
          prompt:
            "Label 3: The step where DNA is used as a template to make RNA is called ________.",
          answers: ["transcription"],
          imageSrc: "images/eukaryote transcription and translation.png",
        },
        {
          id: 4,
          label: "4",
          prompt:
            "Label 4: The step where mRNA is used as a template to build a polypeptide is called ________.",
          answers: ["translation"],
          imageSrc: "images/eukaryote transcription and translation.png",
        },
        {
          id: 5,
          label: "5",
          prompt:
            "Label 5: The process in which proteins are broken down when they are no longer needed is called protein ________.",
          answers: [
            "degradation",
            "protein degradation",
            "degradation of protein"
          ],
          imageSrc: "images/eukaryote transcription and translation.png",
        },
      ];

      // ---------------------- QUIZ COMPONENT ----------------------
      function GeneExpressionFitbQuiz() {
        const [responses, setResponses] = React.useState(() =>
          QUESTIONS.reduce((acc, q) => {
            acc[q.id] = "";
            return acc;
          }, {})
        );
        const [results, setResults] = React.useState({});
        const [currentIndex, setCurrentIndex] = React.useState(0);
        const [score, setScore] = React.useState(0);

        const currentQuestion = QUESTIONS[currentIndex];

        const handleChange = (id, value) => {
          setResponses((prev) => ({ ...prev, [id]: value }));
          // clear correctness flag for this question while editing
          setResults((prev) => {
            const updated = { ...prev };
            delete updated[id];
            return updated;
          });
        };

        const handleCheckCurrent = () => {
          const q = currentQuestion;
          const userAnswerRaw = responses[q.id] || "";
          const isCorrect = matchFITB(userAnswerRaw, q.answers);

          setResults((prev) => ({ ...prev, [q.id]: isCorrect }));

          // recompute score based on all results (including this one)
          const newResults = { ...results, [q.id]: isCorrect };
          let correctCount = 0;
          QUESTIONS.forEach((question) => {
            if (newResults[question.id]) correctCount += 1;
          });
          setScore(correctCount);
        };

        const goNext = () => {
          if (currentIndex < QUESTIONS.length - 1) {
            setCurrentIndex((i) => i + 1);
          }
        };

        const goPrev = () => {
          if (currentIndex > 0) {
            setCurrentIndex((i) => i - 1);
          }
        };

        const answerFilled =
          (responses[currentQuestion.id] || "").trim().length > 0;
        const isCorrect = results[currentQuestion.id];
        const isIncorrect =
          Object.prototype.hasOwnProperty.call(results, currentQuestion.id) &&
          !isCorrect;

        return (
          <div className="max-w-3xl w-full bg-white shadow-lg rounded-xl p-6 md:p-8 space-y-6">
            <h1 className="text-2xl md:text-3xl font-bold text-center text-slate-800 mb-4">
              Eukaryotic Gene Expression – FITB Quiz
            </h1>

            {/* Image displayed above the current question */}
            <div className="w-full flex justify-center mb-2">
              <img
                src={currentQuestion.imageSrc}
                alt={`Diagram for label ${currentQuestion.label}`}
                className="max-h-[420px] w-auto border rounded-lg shadow-sm"
              />
            </div>

            <p className="text-xs md:text-sm text-slate-600 text-center mb-2">
              Question {currentIndex + 1} of {QUESTIONS.length}
            </p>

            {/* Single current question */}
            <div className="border rounded-lg p-4 bg-slate-50 flex flex-col gap-2">
              <div className="flex items-center gap-2">
                <span className="inline-flex items-center justify-center w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-semibold">
                  {currentQuestion.label}
                </span>
                <span className="text-sm text-slate-700">
                  (Label {currentQuestion.label} in the figure)
                </span>
              </div>
              <p className="text-slate-800 text-sm md:text-base">
                {currentQuestion.prompt}
              </p>
              <input
                type="text"
                value={responses[currentQuestion.id] || ""}
                onChange={(e) =>
                  handleChange(currentQuestion.id, e.target.value)
                }
                className={`mt-1 w-full rounded-md border px-3 py-2 text-sm md:text-base bg-white ${
                  isCorrect
                    ? "border-emerald-500 ring-1 ring-emerald-300"
                    : isIncorrect
                    ? "border-rose-500 ring-1 ring-rose-300"
                    : "border-slate-300"
                }`}
                placeholder="Type your answer here"
              />
              {Object.prototype.hasOwnProperty.call(
                results,
                currentQuestion.id
              ) && (
                <div className="text-xs md:text-sm mt-1">
                  {isCorrect ? (
                    <span className="text-emerald-600 font-semibold">
                      ✔ Correct
                    </span>
                  ) : (
                    <span className="text-rose-600">
                      ✘ Incorrect. One acceptable answer:{" "}
                      <span className="font-semibold">
                        {currentQuestion.answers[0]}
                      </span>
                    </span>
                  )}
                </div>
              )}
            </div>

            {/* Controls */}
            <div className="flex flex-col md:flex-row items-center justify-between gap-3 mt-4">
              <div className="flex items-center gap-2">
                <button
                  onClick={goPrev}
                  disabled={currentIndex === 0}
                  className={`px-4 py-2 rounded-md text-sm font-semibold shadow-sm transition ${
                    currentIndex === 0
                      ? "bg-slate-300 text-slate-600 cursor-not-allowed"
                      : "bg-slate-200 text-slate-800 hover:bg-slate-300"
                  }`}
                >
                  Previous
                </button>
                <button
                  onClick={goNext}
                  disabled={currentIndex === QUESTIONS.length - 1}
                  className={`px-4 py-2 rounded-md text-sm font-semibold shadow-sm transition ${
                    currentIndex === QUESTIONS.length - 1
                      ? "bg-slate-300 text-slate-600 cursor-not-allowed"
                      : "bg-slate-200 text-slate-800 hover:bg-slate-300"
                  }`}
                >
                  Next
                </button>
              </div>

              <button
                onClick={handleCheckCurrent}
                disabled={!answerFilled}
                className={`px-5 py-2.5 rounded-md text-sm font-semibold text-white shadow-sm transition ${
                  answerFilled
                    ? "bg-indigo-600 hover:bg-indigo-700"
                    : "bg-slate-400 cursor-not-allowed"
                }`}
              >
                Check Answer
              </button>

              <div className="text-sm md:text-base font-semibold text-slate-800">
                Correct so far: {score} / {QUESTIONS.length}
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<GeneExpressionFitbQuiz />);
    </script>
  </body>
</html>
