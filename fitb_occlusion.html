<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exam 4 - FITB (Image Occlusion)</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    input[type="text"] {
      outline: none;
    }

    /* --- Celebration styles: confetti, streamers, dragon fruit, explosion, text --- */
    .confetti-piece {
      position: fixed;
      top: -10px;
      width: 8px;
      height: 14px;
      border-radius: 9999px;
      opacity: 0.9;
      z-index: 9999;
      pointer-events: none;
      animation-name: confetti-fall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }

    .streamer-piece {
      position: fixed;
      top: -20px;
      width: 5px;
      height: 60px;
      border-radius: 9999px;
      opacity: 0.85;
      z-index: 9999;
      pointer-events: none;
      animation-name: streamer-fall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }

    .fruit-piece {
      position: fixed;
      top: -30px;
      width: 168px;
      height: 256px;
      z-index: 10000;
      pointer-events: none;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAADTCAYAAACoTw7DAADgoklEQVR4nOz9aaxtSXbfif1i2MMZ7vjGfPkys6qyBhYpTiLllgQZMtBGuwUDbXfbsA30J7cBA/7SgFvf2gPgbhndbqkB2ZKbsgRB1kSKYLOoosR5HqpIVhXJKtacWZXjy3zze3c6wx4iwh/2WeeuE++8fDepEgmYGYmX995z9o4dO2KN/7VihUkp8UH7oH3Q/v+72T/tAXzQPmgftH/77QNG/6B90P4MtA8Y/YP2Qfsz0D5g9A/aB+3PQPuA0T9oH7Q/A+0DRv+gfdD+DLQPGP2D9kH7M9A+YPQP2gftz0D7gNE/aB+0PwPN/0k8JMZI13V0XUdKCeccxhgAjDHEGOn7nq7riDFijMHaQQallKiqCu89MUYkk6/ve5qmwTmHtZYQAikXpqPcNhoqKJzQfhdkksUBEDcmLgjtLDM/tY7CGmmhL3szY636wnNqB1AB8olMIN0sP9nlM+a64SyXnNTVHyermn8vnPPSU3mTyldCF1f7kn1+uRjS3PICOblDw3MY0Umjoej79gVP1B7e2XEYamtV6760mdR56aufiW6z5Jd8nF6fyVbxB5okouJw+apFZsAmjStXlkXJ47LBG+vFaqBkmdyUVXiR3I3+XzkQfqKK3R4cyMY7SJ0XHer51djDFQEhH3cFaUL43rTJSMCTNsYc9LEv58eOSa0AadQJvhkEgE5Vy0yad58lF0UIBRmqos11xdqk5Sb03ruiltkySQnJjlAS51+5xbSrNXHg2XRzjKtU/95/7p0lKS+s6fL32emwNl3PnbqYM/qH3BqPs77Z32Tvv/f/uDO1Leae+0d9r/Z+0dQn+nvdP+ELR3CP2d9k77Q9DeIfR32jvtD0F7h9Dfae+0PwTtHUJ/p73T/hC0dwj9nfZO+0PQ3iH0d9o77Q9B+38B27GxKuChISkAAAAASUVORK5CYII=');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      animation-name: fruit-fall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }

    .explosion {
      position: fixed;
      top: 40vh;
      left: 50vw;
      transform: translate(-50%, -50%);
      width: 200vw;
      height: 200vh;
      border-radius: 50%;
      background: radial-gradient(circle, #ffec00, #ff6a00, #ff0000);
      opacity: 0;
      animation: explode 4.8s forwards;
      z-index: 11000;
    }

    .hay-text {
      position: fixed;
      top: 50vh;
      left: 50vw;
      transform: translate(-50%, -50%);
      font-size: 80px;
      font-weight: bold;
      color: #ff1493;
      opacity: 0;
      z-index: 12000;
      animation: hay-pop 1.4s forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translate3d(0, -10px, 0) rotateZ(0deg);
      }
      100% {
        transform: translate3d(0, 110vh, 0) rotateZ(360deg);
      }
    }

    @keyframes streamer-fall {
      0% {
        transform: translate3d(0, -20px, 0) rotateZ(0deg);
      }
      50% {
        transform: translate3d(20px, 50vh, 0) rotateZ(180deg);
      }
      100% {
        transform: translate3d(-20px, 110vh, 0) rotateZ(360deg);
      }
    }

    @keyframes fruit-fall {
      0% {
        transform: translate3d(0, -30px, 0) scale(0.8);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      100% {
        transform: translate3d(0, 110vh, 0) scale(1);
        opacity: 0;
      }
    }

    @keyframes explode {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.1);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.4);
      }
    }

    @keyframes hay-pop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.3);
      }
      60% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.05);
      }
      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    @keyframes hay-fade {
      to {
        opacity: 0;
      }
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div id="root"></div>

  <script type="text/babel">
    /**********************  LENIENT MATCH HELPERS  **********************/
    const STOP = new Set(["a","an","the","of","to","and","for","in","on","at","is"]);

    const IRREG = new Map([
      ["children","child"],["mice","mouse"],["men","man"],["women","woman"],
      ["teeth","tooth"],["feet","foot"],["geese","goose"],
      ["nuclei","nucleus"],["bacteria","bacterium"],["data","datum"],
      ["media","medium"],["criteria","criterion"],["indices","index"],
      ["matrices","matrix"],["codices","codex"],["lives","life"],["leaves","leaf"]
    ]);

    const norm = (s) =>
      String(s == null ? "" : s)
        .toLowerCase()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[‐-‒–—―]/g, "-")
        .replace(/β/g, "beta")
        .replace(/α/g, "alpha")
        .replace(/γ/g, "gamma")
        .replace(/μ/g, "micro")
        .replace(/ß/g, "ss")
        .replace(/[^a-z0-9\s\-+\/.%]/g, " ")
        .replace(/\s+/g, " ")
        .trim();

    const singularize = (w) => {
      if (IRREG.has(w)) return IRREG.get(w);
      if (w.endsWith("ies") && w.length > 3) return w.slice(0, -3) + "y";
      if (/(ches|shes|xes|zes)$/.test(w)) return w.slice(0, -2);
      if (/ves$/.test(w))
        return w.slice(0, -3) + (w.endsWith("ves") ? (w.slice(-4, -3) === "i" ? "fe" : "f") : "f");
      if (w.endsWith("es") &&
          !w.endsWith("ses") &&
          !/(ches|shes|xes|zes)$/.test(w)) return w.slice(0, -2);
      if (w.endsWith("s") && !w.endsWith("ss")) return w.slice(0, -1);
      return w;
    };

    const baseForm = (s) =>
      norm(s)
        .replace(/[-_]/g, " ")
        .split(" ")
        .filter(Boolean)
        .map((w) => singularize(w))
        .join(" ");

    const tokens = (s) =>
      baseForm(s)
        .split(" ")
        .filter((w) => w && !STOP.has(w));

    const lev = (a, b) => {
      a = baseForm(a); b = baseForm(b);
      if (a === b) return 0;
      const m = a.length, n = b.length;
      if (!m) return n; if (!n) return m;
      const v0 = new Array(n + 1), v1 = new Array(n + 1);
      for (let i = 0; i <= n; i++) v0[i] = i;
      for (let i = 0; i < m; i++) {
        v1[0] = i + 1;
        for (let j = 0; j < n; j++) {
          const cost = a[i] === b[j] ? 0 : 1;
          v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
        }
        for (let j = 0; j <= n; j++) v0[j] = v1[j];
      }
      return v0[n];
    };

    const eqLoose = (a, b) => {
      const na = norm(a), nb = norm(b);
      if (na === nb) return true;

      const ta = tokens(na), tb = tokens(nb);
      if (ta.length && tb.length) {
        const setB = new Set(tb);
        let inter = 0;
        for (let t of ta) if (setB.has(t)) inter++;
        const unionSize = new Set([...ta, ...tb]).size;
        const jacc = inter / Math.max(1, unionSize);
        if (jacc >= 0.75) return true;

        if (Math.min(ta.length, tb.length) <= 2) {
          const short = ta.length <= tb.length ? ta : tb;
          const longSet = new Set(ta.length <= tb.length ? tb : ta);
          if (short.every((w) => longSet.has(w))) return true;
        }
      }

      const d = lev(na, nb);
      const L = Math.max(na.length, nb.length);
      const thresh = Math.max(1, Math.min(4, Math.round(L * 0.22)));
      return d <= thresh;
    };

    const matchFITB = (userInput, acceptableAnswers) =>
      acceptableAnswers.some((a) => eqLoose(a, userInput));

    /**********************  QUESTIONS WITH EXPLANATIONS  **********************/
    const QUESTIONS = [
      // ---------- PAGE 2 ----------
      {
        id: 1,
        page: 2,
        label: "2-1",
        prompt: "______",
        answers: ["signal", "signals"],
        imageSrc: "images/image2.png",
        exp: "An extracellular signal starts a signaling pathway that ultimately regulates gene expression inside the nucleus."
      },
      {
        id: 2,
        page: 2,
        label: "2-2",
        prompt: "______",
        answers: ["chromatin modification", "chromatin modifications"],
        imageSrc: "images/image2.png",
        exp: "Chromatin modifications (like DNA methylation or histone acetylation) change how tightly DNA is packed and how accessible genes are."
      },
      {
        id: 3,
        page: 2,
        label: "2-3",
        prompt: "______",
        answers: ["transcription"],
        imageSrc: "images/image2.png",
        exp: "Transcription is the process of copying information from DNA into an RNA transcript."
      },
      {
        id: 4,
        page: 2,
        label: "2-4",
        prompt: "______",
        answers: ["translation"],
        imageSrc: "images/image2.png",
        exp: "Translation is the process in which ribosomes use the mRNA sequence to build a polypeptide (protein)."
      },
      {
        id: 5,
        page: 2,
        label: "2-5",
        prompt: "______",
        answers: ["protein degradation", "degradation of protein"],
        imageSrc: "images/image2.png",
        exp: "Protein degradation removes proteins that are damaged, misfolded, or no longer needed, helping regulate their levels."
      },

      // ---------- PAGE 4 ----------
      {
        id: 6,
        page: 4,
        label: "4-1",
        prompt: "______",
        answers: ["chromosome"],
        imageSrc: "images/image4.png",
        exp: "The most condensed form of DNA is a chromosome, which forms from tightly packed chromatin."
      },
      {
        id: 7,
        page: 4,
        label: "4-2",
        prompt: "______",
        answers: ["chromatin"],
        imageSrc: "images/image4.png",
        exp: "Chromatin is the complex of DNA and proteins that can be compact or open, affecting gene expression."
      },
      {
        id: 8,
        page: 4,
        label: "4-3",
        prompt: "______",
        answers: ["methyl group", "methyl", "DNA methylation"],
        imageSrc: "images/image4.png",
        exp: "Addition of methyl groups to DNA (DNA methylation) is often associated with gene silencing."
      },
      {
        id: 9,
        page: 4,
        label: "4-4",
        prompt: "______",
        answers: ["acetyl group", "acetyl", "histone acetylation"],
        imageSrc: "images/image4.png",
        exp: "Acetyl groups added to histone tails loosen chromatin and usually increase gene expression."
      },

      // ---------- PAGE 6 ----------
      {
        id: 10,
        page: 6,
        label: "6-1",
        prompt: "______",
        answers: ["methylation", "dna methylation"],
        imageSrc: "images/image6.png",
        exp: "DNA methylation causes nucleosomes to pack tightly so transcription factors cannot access the DNA."
      },
      {
        id: 11,
        page: 6,
        label: "6-2",
        prompt: "______",
        answers: ["acetylation", "histone acetylation"],
        imageSrc: "images/image6.png",
        exp: "Histone acetylation loosens nucleosome packing so transcription factors can bind and genes can be expressed."
      },

      // ---------- PAGE 8 ----------
      {
        id: 12,
        page: 8,
        label: "8-1",
        prompt: "______",
        answers: ["present"],
        imageSrc: "images/image8.png",
        exp: "Tryptophan acts as a corepressor that binds the trp repressor."
      },
      {
        id: 13,
        page: 8,
        label: "8-2",
        prompt: "______",
        answers: ["blocked", "inhibited"],
        imageSrc: "images/image8.png",
        exp: "When the repressor is bound, transcription of the trp operon is blocked or inhibited."
      },
      {
        id: 14,
        page: 8,
        label: "8-3",
        prompt: "______",
        answers: ["tryptophan"],
        imageSrc: "images/image8.png",
        exp: "High tryptophan levels activate the repressor so the cell stops making more tryptophan."
      },
      {
        id: 15,
        page: 8,
        label: "8-4",
        prompt: "______",
        answers: ["absence"],
        imageSrc: "images/image8.png",
        exp: "In the absence of tryptophan, the repressor cannot bind DNA and transcription proceeds."
      },
      {
        id: 16,
        page: 8,
        label: "8-5",
        prompt: "______",
        answers: ["repressor"],
        imageSrc: "images/image8.png",
        exp: "The trp repressor protein binds the operator to turn off transcription when activated by tryptophan."
      },

      // ---------- PAGE 12 ----------
      {
        id: 17,
        page: 12,
        label: "12-1",
        prompt: "______",
        answers: ["camp"],
        imageSrc: "images/image12.png",
        exp: "cAMP levels rise when glucose is low and this allows CAP to bind DNA and stimulate transcription."
      },
      {
        id: 18,
        page: 12,
        label: "12-2",
        prompt: "______",
        answers: ["low", "low rate"],
        imageSrc: "images/image12.png",
        exp: "Without CAP–cAMP bound, RNA polymerase has only a low rate of transcription at the lac promoter."
      },
      {
        id: 19,
        page: 12,
        label: "12-3",
        prompt: "______",
        answers: ["transcription"],
        imageSrc: "images/image12.png",
        exp: "CAP–cAMP binding increases the rate of transcription of the lac operon genes."
      },

      // ---------- PAGE 14 ----------
      {
        id: 20,
        page: 14,
        label: "14-1",
        prompt: "______",
        answers: ["distal control element", "distal control elements"],
        imageSrc: "images/image14.png",
        exp: "A distal control element is a regulatory DNA sequence located far from a promoter. Activator proteins bind these elements (often enhancers) and interact with the transcription machinery through DNA looping."
      },
      {
        id: 21,
        page: 14,
        label: "14-2",
        prompt: "______",
        answers: ["TATA", "TATA box"],
        imageSrc: "images/image14.png",
        exp: "The TATA box is a short DNA sequence within the promoter that binds transcription factors and helps position RNA polymerase II at the correct start site for transcription."
      },
      {
        id: 22,
        page: 14,
        label: "14-3",
        prompt: "______",
        answers: ["general transcription factors", "general transcription factor", "gtfs"],
        imageSrc: "images/image14.png",
        exp: "General transcription factors are proteins that bind to the promoter (including the TATA box) and recruit RNA polymerase II, forming the transcription initiation complex."
      },
      {
        id: 23,
        page: 14,
        label: "14-4",
        prompt: "______",
        answers: ["transcription initiation complex", "initiation complex"],
        imageSrc: "images/image14.png",
        exp: "The transcription initiation complex is the assembled set of general transcription factors and RNA polymerase II bound at the promoter, ready to begin RNA synthesis."
      },

      // ---------- PAGE 16 ----------
      {
        id: 24,
        page: 16,
        label: "16-1",
        prompt: "______",
        answers: ["albumin activators"],
        imageSrc: "images/image16.png",
        exp: "In liver cells, albumin-specific activators are present and turn on the albumin gene."
      },
      {
        id: 25,
        page: 16,
        label: "16-2",
        prompt: "______",
        answers: ["expressed", "is expressed"],
        imageSrc: "images/image16.png",
        exp: "In liver cells, the albumin gene is expressed because liver-specific activator proteins are present, allowing transcription to occur."
      },
      {
        id: 26,
        page: 16,
        label: "16-3",
        prompt: "______",
        answers: ["off"],
        imageSrc: "images/image16.png",
        exp: "In liver cells the crystallin gene is kept OFF because its activators are not present."
      },

      // ---------- PAGE 18 ----------
      {
        id: 27,
        page: 18,
        label: "18-1",
        prompt: "______",
        answers: ["crystallin activators"],
        imageSrc: "images/image18.png",
        exp: "In lens cells, crystallin-specific activators are present and drive expression of the crystallin gene."
      },
      {
        id: 28,
        page: 18,
        label: "18-2",
        prompt: "______",
        answers: ["expressed"],
        imageSrc: "images/image18.png",
        exp: "In lens cells, the crystallin gene is expressed because lens-specific activator proteins are present and recruit the transcription machinery."
      },
      {
        id: 29,
        page: 18,
        label: "18-3",
        prompt: "______",
        answers: ["off", "not expressed"],
        imageSrc: "images/image18.png",
        exp: "In lens cells the albumin gene stays OFF because the liver-specific activators are absent."
      },


// ---------- PAGE 20 ----------
{
  id: 30,
  page: 20,
  label: "20-1",
  prompt: "______",
  answers: ["pre-mRNA", "premrna"],
  imageSrc: "images/image20.png",
  exp: "Pre-mRNA is the primary RNA transcript produced by transcription and contains both exons and introns before RNA processing."
},
{
  id: 31,
  page: 20,
  label: "20-2",
  prompt: "______",
  answers: ["spliced mRNA", "mature mRNA", "alternatively spliced mRNA"],
  imageSrc: "images/image20.png",
  exp: "Spliced mRNA is produced after introns are removed and exons are joined together, with alternative splicing generating multiple mRNA isoforms from a single gene."
},

// ---------- PAGE 22 ----------
{
  id: 32,
  page: 22,
  label: "22-1",
  prompt: "______",
  answers: ["RNA-binding proteins", "rna binding proteins"],
  imageSrc: "images/image22.png",
  exp: "RNA-binding proteins associate with mRNA and regulate processes such as stability, localization, and translation."
},
{
  id: 33,
  page: 22,
  label: "22-2",
  prompt: "______",
  answers: ["5' cap", "five prime cap"],
  imageSrc: "images/image22.png",
  exp: "The 5′ cap protects mRNA from degradation and is required for ribosome binding during translation initiation."
},
{
  id: 34,
  page: 22,
  label: "22-3",
  prompt: "______",
  answers: ["poly-A tail", "poly a tail"],
  imageSrc: "images/image22.png",
  exp: "The poly-A tail increases mRNA stability and plays a role in nuclear export and translation efficiency."
},

// ---------- PAGE 24 ----------
{
  id: 35,
  page: 24,
  label: "24-1",
  prompt: "______",
  answers: ["ubiquitin"],
  imageSrc: "images/image24.png",
  exp: "Ubiquitin is a small protein that tags other proteins for destruction by the proteasome."
},
{
  id: 36,
  page: 24,
  label: "24-2",
  prompt: "______",
  answers: ["proteasome"],
  imageSrc: "images/image24.png",
  exp: "The proteasome is a large protein complex that degrades proteins tagged with ubiquitin using ATP."
},
{
  id: 37,
  page: 24,
  label: "24-3",
  prompt: "______",
  answers: ["amino acids"],
  imageSrc: "images/image24.png",
  exp: "Proteins degraded by the proteasome are broken down into individual amino acids."
},
{
  id: 38,
  page: 24,
  label: "24-4",
  prompt: "______",
  answers: ["degradation"],
  imageSrc: "images/image24.png",
  exp: "Ubiquitin-tagged proteins are marked for degradation, allowing cells to control protein quality and abundance."
},

// ---------- PAGE 26 ----------
{
  id: 61,
  page: 26,
  label: "26-1",
  prompt: "______",
  answers: ["recombinant chromosomes", "recombinant chromosome"],
  imageSrc: "images/image26.png",
  exp: "The middle two eggs at the top carry recombinant chromosomes, where crossing over has produced new combinations of b and vg alleles."
},
{
  id: 62,
  page: 26,
  label: "26-2",
  prompt: "______",
  answers: ["testcross offspring", "testcross progeny"],
  imageSrc: "images/image26.png",
  exp: "The rows of fly phenotypes are labeled as testcross offspring, because a heterozygote was crossed with a double recessive tester."
},
{
  id: 63,
  page: 26,
  label: "26-3",
  prompt: "______",
  answers: ["recombinant offspring", "recombinant progeny"],
  imageSrc: "images/image26.png",
  exp: "The gray–vestigial and black–normal flies are recombinant offspring, showing new combinations of body color and wing phenotype."
},

// ---------- PAGE 28 ----------
{
  id: 64,
  page: 28,
  label: "28-1",
  prompt: "______",
  answers: ["homologous chromosomes", "homologous chromosome"],
  imageSrc: "images/image28.png",
  exp: "Panel (a) shows nondisjunction of homologous chromosomes in Meiosis I, producing gametes with n+1 or n−1 chromosomes."
},
{
  id: 65,
  page: 28,
  label: "28-2",
  prompt: "______",
  answers: ["sister chromatids", "sister chromatid"],
  imageSrc: "images/image28.png",
  exp: "Panel (b) shows nondisjunction of sister chromatids in Meiosis II."
},

// ---------- PAGE 30 ----------
{
  id: 66,
  page: 30,
  label: "30-1",
  prompt: "______",
  answers: ["n+1", "n + 1"],
  imageSrc: "images/image30.png",
  exp: "Gametes with n+1 chromosomes contain one extra chromosome due to nondisjunction."
},
{
  id: 67,
  page: 30,
  label: "30-2",
  prompt: "______",
  answers: ["n-1", "n - 1"],
  imageSrc: "images/image30.png",
  exp: "Gametes with n−1 chromosomes are missing one chromosome as a result of nondisjunction."
},

// ---------- PAGE 32 ----------
{
  id: 68,
  page: 32,
  label: "32-1",
  prompt: "______",
  answers: ["autocrine"],
  imageSrc: "images/image32.png",
  exp: "Autocrine signaling occurs when a cell releases a signal that binds to receptors on its own surface."
},
{
  id: 69,
  page: 32,
  label: "32-2",
  prompt: "______",
  answers: ["signaling across gap junctions", "gap junction signaling"],
  imageSrc: "images/image32.png",
  exp: "Signaling across gap junctions occurs through direct cytoplasmic connections between cells."
},
{
  id: 70,
  page: 32,
  label: "32-3",
  prompt: "______",
  answers: ["paracrine"],
  imageSrc: "images/image32.png",
  exp: "Paracrine signaling involves a cell targeting nearby cells using local signaling molecules."
},
{
  id: 71,
  page: 32,
  label: "32-4",
  prompt: "______",
  answers: ["endocrine"],
  imageSrc: "images/image32.png",
  exp: "Endocrine signaling uses hormones released into the bloodstream to act on distant target cells."
},

// ---------- PAGE 34 ----------
{
  id: 72,
  page: 34,
  label: "34-1",
  prompt: "______",
  answers: ["paracrine"],
  imageSrc: "images/image34.png",
  exp: "Synaptic signaling is a specialized form of paracrine signaling."
},
{
  id: 73,
  page: 34,
  label: "34-2",
  prompt: "______",
  answers: ["neurotransmitter", "neurotransmitters"],
  imageSrc: "images/image34.png",
  exp: "Neurotransmitters are chemical messengers released into the synapse."
},

// ---------- PAGE 36 ----------
{
  id: 74,
  page: 36,
  label: "36-1",
  prompt: "______",
  answers: ["g-protein-coupled receptor", "g protein-coupled receptor", "gpcr"],
  imageSrc: "images/image36.png",
  exp: "A G-protein-coupled receptor binds a signaling molecule and activates a G protein."
},
{
  id: 75,
  page: 36,
  label: "36-2",
  prompt: "______",
  answers: ["signaling molecule", "signal molecule", "ligand"],
  imageSrc: "images/image36.png",
  exp: "A signaling molecule binds to the receptor to initiate signal transduction."
},
{
  id: 76,
  page: 36,
  label: "36-3",
  prompt: "______",
  answers: ["cellular response", "response"],
  imageSrc: "images/image36.png",
  exp: "Activation of the G protein ultimately leads to a cellular response."
},

// ---------- PAGE 38 ----------
{
  id: 77,
  page: 38,
  label: "38-1",
  prompt: "______",
  answers: ["signal molecule", "signaling molecule"],
  imageSrc: "images/image38.png",
  exp: "Signal molecules bind to receptor tyrosine kinases to activate them."
},
{
  id: 78,
  page: 38,
  label: "38-2",
  prompt: "______",
  answers: ["ATP"],
  imageSrc: "images/image38.png",
  exp: "ATP provides phosphate groups used to activate receptor tyrosine kinases."
},
{
  id: 79,
  page: 38,
  label: "38-3",
  prompt: "______",
  answers: ["cellular response", "cellular responses"],
  imageSrc: "images/image38.png",
  exp: "Activated relay proteins lead to specific cellular responses."
},

// ---------- PAGE 40 (Intracellular receptor signaling) ----------
{
  id: 80,
  page: 40,
  label: "40-1",
  prompt: "______",
  answers: ["signaling molecule", "signal molecule"],
  imageSrc: "images/image40.png",
  exp: "Small hydrophobic signaling molecules can diffuse across the plasma membrane and bind intracellular receptors."
},
{
  id: 81,
  page: 40,
  label: "40-2",
  prompt: "______",
  answers: ["intracellular receptor"],
  imageSrc: "images/image40.png",
  exp: "Intracellular receptors are located in the cytoplasm or nucleus and bind signaling molecules that can cross the plasma membrane."
},

// ---------- PAGE 42 (Second messenger formation) ----------
{
  id: 82,
  page: 42,
  label: "42-1",
  prompt: "______",
  answers: ["adenylyl cyclase", "adenylate cyclase"],
  imageSrc: "images/image42.png",
  exp: "Adenylyl cyclase converts ATP into cyclic AMP (cAMP), a second messenger."
},

// ---------- PAGE 44 (Gated ion channels example) ----------
{
  id: 83,
  page: 44,
  label: "44-1",
  prompt: "______",
  answers: ["ions"],
  imageSrc: "images/image44.png",
  exp: "When a gated ion channel opens, ions flow across the membrane down their electrochemical gradient."
},
{
  id: 84,
  page: 44,
  label: "44-2",
  prompt: "______",
  answers: ["open channel", "ion channel"],
  imageSrc: "images/image44.png",
  exp: "Binding of a signaling molecule causes the ion channel to open, allowing ion passage."
},

// ---------- PAGE 46 (Receptor tyrosine kinase) ----------
{
  id: 85,
  page: 46,
  label: "46-1",
  prompt: "______",
  answers: ["signaling molecule", "ligand"],
  imageSrc: "images/image46.png",
  exp: "Binding of signaling molecules to receptor tyrosine kinases causes receptor dimerization."
},
{
  id: 86,
  page: 46,
  label: "46-2",
  prompt: "______",
  answers: ["tyrosine residues"],
  imageSrc: "images/image46.png",
  exp: "Tyrosine residues on the intracellular domain are phosphorylated following receptor activation."
},
{
  id: 87,
  page: 46,
  label: "46-3",
  prompt: "______",
  answers: ["cellular response"],
  imageSrc: "images/image46.png",
  exp: "Phosphorylation of tyrosine residues triggers downstream signaling leading to a cellular response."
},

// ---------- PAGE 48 (EGF–RAS–MAPK signaling pathway) ----------
{
  id: 88,
  page: 48,
  label: "48-1",
  prompt: "______",
  answers: ["EGF", "epidermal growth factor"],
  imageSrc: "images/image48.png",
  exp: "EGF binds to the EGF receptor (EGFR), initiating a signaling cascade."
},
{
  id: 89,
  page: 48,
  label: "48-2",
  prompt: "______",
  answers: ["EGFR", "EGF receptor"],
  imageSrc: "images/image48.png",
  exp: "EGFR is a receptor tyrosine kinase that dimerizes upon ligand binding."
},
{
  id: 90,
  page: 48,
  label: "48-3",
  prompt: "______",
  answers: ["cell proliferation", "cell growth"],
  imageSrc: "images/image48.png",
  exp: "Activation of the MAP kinase pathway can stimulate translation and cell proliferation."
},


    ];

    const MODULE_NAME = "Lec16 Ch16 Gene Expression";
    const ALL_QUESTIONS = QUESTIONS.map((q) => ({ ...q, module: MODULE_NAME }));

    const formatTime = (seconds) => {
      if (!seconds && seconds !== 0) return "—";
      const s = Math.round(seconds);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${r.toString().padStart(2, "0")}`;
    };

    /**********************  QUIZ COMPONENT  **********************/
    function ImageOcclusionFitbQuiz() {
      const [questions, setQuestions] = React.useState(() => [...ALL_QUESTIONS]);
      const [currentIndex, setCurrentIndex] = React.useState(0);
      const [responses, setResponses] = React.useState(() =>
        ALL_QUESTIONS.reduce((acc, q) => {
          acc[q.id] = "";
          return acc;
        }, {})
      );
      const [results, setResults] = React.useState({});
      const [submitted, setSubmitted] = React.useState({});
      const [timeSpent, setTimeSpent] = React.useState({});
      const [viewStart, setViewStart] = React.useState(Date.now());

      const [celebrated, setCelebrated] = React.useState(false);

      const moduleNames = React.useMemo(() => {
        const set = new Set(ALL_QUESTIONS.map((q) => q.module));
        return Array.from(set).sort();
      }, []);

      const [selectedModules, setSelectedModules] = React.useState(["All (Mixed)"]);
      const [questionCount, setQuestionCount] = React.useState("");

      const applySession = React.useCallback(
        (mods, countStr) => {
          const useAll = !mods.length || mods.includes("All (Mixed)");
          let pool = useAll
            ? ALL_QUESTIONS
            : ALL_QUESTIONS.filter((q) => mods.includes(q.module));

          // Shuffle
          pool = [...pool];
          for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
          }

          // Question-count limit
          let n = parseInt(String(countStr).trim(), 10);
          if (Number.isFinite(n) && n > 0) {
            if (n > pool.length) n = pool.length;
            pool = pool.slice(0, n);
          }

          setQuestions(pool);
          setCurrentIndex(0);

          const freshResponses = pool.reduce((acc, q) => {
            acc[q.id] = "";
            return acc;
          }, {});
          setResponses(freshResponses);
          setResults({});
          setSubmitted({});
          setTimeSpent({});
          setCelebrated(false);
          setViewStart(Date.now());
        },
        [setCelebrated]
      );

      React.useEffect(() => {
        applySession(["All (Mixed)"], "");
      }, [applySession]);

      React.useEffect(() => {
        setViewStart(Date.now());
      }, [currentIndex, questions]);

      const currentQuestion = questions[currentIndex] || questions[0];
      if (!currentQuestion) {
        return (
          <div className="max-w-5xl w-full bg-white shadow-lg rounded-xl p-6 md:p-8 space-y-6">
            <h1 className="text-2xl md:text-3xl font-bold text-center text-slate-800 mb-4">
              Exam 4 - FITB (Image Occlusion)
            </h1>
            <p className="text-center text-sm text-slate-600">
              No questions available for this selection. Try selecting a different
              module or increasing the question count.
            </p>
          </div>
        );
      }

      const itemNumber = React.useMemo(() => {
        const raw = String(currentQuestion.label || "");
        const parts = raw.split("-");
        const last = parts[parts.length - 1];
        const n = parseInt(last, 10);
        return isNaN(n) ? raw : n;
      }, [currentQuestion.label]);

      const handleChange = (id, value) => {
        if (submitted[id]) return;
        setResponses((prev) => ({ ...prev, [id]: value }));
        setResults((prev) => {
          const clone = { ...prev };
          delete clone[id];
          return clone;
        });
      };

      const handleCheckCurrent = () => {
        const q = currentQuestion;
        if (submitted[q.id]) return;

        const now = Date.now();
        const elapsed = (now - viewStart) / 1000;

        const userAnswer = responses[q.id] || "";
        const isCorrect = matchFITB(userAnswer, q.answers);

        setResults((prev) => ({ ...prev, [q.id]: isCorrect }));
        setSubmitted((prev) => ({ ...prev, [q.id]: true }));
        setTimeSpent((prev) => ({
          ...prev,
          [q.id]: (prev[q.id] || 0) + elapsed,
        }));
        setViewStart(now);
      };

      const goNext = () => {
        if (currentIndex < questions.length - 1) {
          setCurrentIndex((i) => i + 1);
        }
      };

      const goPrev = () => {
        if (currentIndex > 0) {
          setCurrentIndex((i) => i - 1);
        }
      };

      const answerFilled =
        (responses[currentQuestion.id] || "").trim().length > 0;

      const isCorrect = results[currentQuestion.id];
      const isIncorrect =
        Object.prototype.hasOwnProperty.call(results, currentQuestion.id) &&
        !isCorrect;

      const correctCount = questions.reduce(
        (count, q) => (results[q.id] ? count + 1 : count),
        0
      );
      const total = questions.length;

      const completedCount = questions.reduce(
        (c, q) => (submitted[q.id] ? c + 1 : c),
        0
      );
      const completedPercent =
        total === 0 ? 0 : Math.round((completedCount / total) * 100);

      const incorrectCount = Math.max(0, completedCount - correctCount);
      const gradePercent =
        completedCount === 0
          ? 0
          : Math.round((correctCount / completedCount) * 100);

      const allAttempted =
        total > 0 && questions.every((q) => submitted[q.id]);

      // Celebration when session finished with ≥85% correct
      React.useEffect(() => {
        if (!questions.length) return;
        const totalQ = questions.length;
        const correct = questions.reduce(
          (c, q) => (results[q.id] ? c + 1 : c),
          0
        );
        const attempted = questions.reduce(
          (c, q) => (submitted[q.id] ? c + 1 : c),
          0
        );
        const pct = Math.round((correct / totalQ) * 100);
        const allDone = totalQ > 0 && attempted === totalQ;

        if (
          !celebrated &&
          allDone &&
          pct >= 85 &&
          typeof window.launchConfetti === "function"
        ) {
          window.launchConfetti(120);
          setCelebrated(true);
        }
      }, [questions, results, submitted, celebrated]);

      const handleModuleSelectChange = (e) => {
        const selected = Array.from(e.target.selectedOptions).map(
          (opt) => opt.value
        );
        setSelectedModules(selected);
        applySession(selected, questionCount);
      };

      const handleModuleAll = () => {
        const mods = ["All (Mixed)"];
        setSelectedModules(mods);
        applySession(mods, questionCount);
      };

      const handleModuleClear = () => {
        const mods = [];
        setSelectedModules(mods);
        applySession(mods, questionCount);
      };

      const handleQuestionCountChange = (e) => {
        const onlyDigits = e.target.value.replace(/[^0-9]/g, "");
        setQuestionCount(onlyDigits);
      };

      const handleRestartClick = () => {
        applySession(selectedModules, questionCount);
      };

      const handleReviewIncorrect = () => {
        const incorrectQs = questions.filter(
          (q) => submitted[q.id] && !results[q.id]
        );
        if (!incorrectQs.length) return;

        setQuestions(incorrectQs);
        setCurrentIndex(0);

        const freshResponses = incorrectQs.reduce((acc, q) => {
          acc[q.id] = "";
          return acc;
        }, {});
        setResponses(freshResponses);
        setResults({});
        setSubmitted({});
        setTimeSpent({});
        setCelebrated(false);
        setViewStart(Date.now());
      };

      const moduleOptions = ["All (Mixed)", ...moduleNames];

      return (
        <div className="w-full flex flex-col items-center px-4 py-4">
          <div className="w-full max-w-5xl flex justify-end mb-3">
            <button
              type="button"
              onClick={() => (window.location.href = "index.html")}
              className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-slate-300 bg-white text-xs md:text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50"
            >
              <span className="text-lg leading-none">←</span>
              <span>Back to Menu</span>
            </button>
          </div>
          <div className="max-w-5xl w-full bg-white shadow-lg rounded-xl p-6 md:p-8 space-y-6">
          <h1 className="text-2xl md:text-3xl font-bold text-center text-slate-800 mb-4">
            Exam 4 - FITB (Image Occlusion)
          </h1>

          {/* Top controls */}
          <div className="grid md:grid-cols-2 gap-4 mb-4">
            <div className="border rounded-xl bg-slate-50 p-4">
              <div className="flex items-center justify-between mb-2">
                <h2 className="text-sm font-semibold text-slate-800">
                  Modules (multi-select)
                </h2>
                <div className="flex gap-2">
                  <button
                    onClick={handleModuleAll}
                    className="text-xs px-2 py-1 rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300"
                  >
                    All
                  </button>
                  <button
                    onClick={handleModuleClear}
                    className="text-xs px-2 py-1 rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300"
                  >
                    Clear
                  </button>
                </div>
              </div>

              <select
                multiple
                value={selectedModules}
                onChange={handleModuleSelectChange}
                className="w-full h-28 border rounded-md px-2 py-1 text-xs md:text-sm bg-white"
              >
                {moduleOptions.map((m) => (
                  <option key={m} value={m}>
                    {m}
                  </option>
                ))}
              </select>

              <p className="mt-2 text-[11px] text-slate-500">
                Tip: Hold Ctrl/Cmd (desktop) to select multiple modules. Selecting
                “All (Mixed)” uses all questions.
              </p>
              <p className="text-[11px] text-slate-500">
                Selecting modules and clicking “Restart / Reshuffle” starts a new
                session with only those modules.
              </p>
            </div>

            <div className="border rounded-xl bg-slate-50 p-4 flex flex-col gap-2">
              <h2 className="text-sm font-semibold text-slate-800">
                Question Count
              </h2>
              <input
                type="text"
                inputMode="numeric"
                value={questionCount}
                onChange={handleQuestionCountChange}
                placeholder="e.g., 20 (leave blank for all)"
                className="w-full border rounded-md px-3 py-2 text-sm bg-white"
              />
              <p className="text-[11px] text-slate-500">
                Enter a number (e.g., 20), or leave blank to use all questions.
              </p>
              <div className="mt-1">
                <button
                  onClick={handleRestartClick}
                  className="px-4 py-2 rounded-md text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm"
                >
                  Restart / Reshuffle
                </button>
              </div>
            </div>
          </div>

          {/* Header bar */}
          <div className="border rounded-xl bg-slate-50 p-3 mb-2">
            <div className="flex items-center justify-between text-xs md:text-sm text-slate-700 mb-2">
              <span>
                Question {currentIndex + 1}/{questions.length}
              </span>
              <span>
                Score: {correctCount}/{completedCount || 0} attempted (
                {completedCount === 0 ? 0 : gradePercent}%)
              </span>
            </div>
            <div className="w-full h-2 rounded-full bg-slate-200 overflow-hidden">
              <div
                className="h-full bg-indigo-500 transition-all"
                style={{ width: `${completedPercent}%` }}
              ></div>
            </div>
          </div>

          {/* Image */}
          <div className="w-full flex justify-center mb-2">
            <img
              src={currentQuestion.imageSrc}
              alt={`Occluded figure for label ${currentQuestion.label}`}
              className="max-h-[420px] w-auto border rounded-lg shadow-sm"
            />
          </div>

          {/* Question card */}
          <div className="border rounded-lg p-4 bg-slate-50 flex flex-col gap-2">
            <div className="flex items-center gap-2">
              <span
                className="inline-flex items-center justify-center px-3 py-1 text-black text-sm font-semibold shadow-sm"
                style={{ backgroundColor: "#ff8a80", borderRadius: "3px" }}
              >
                {itemNumber}
              </span>
              <span className="text-sm text-slate-800 font-medium">
                Identify the item in the figure.
              </span>
            </div>

            <input
              type="text"
              value={responses[currentQuestion.id] || ""}
              onChange={(e) =>
                handleChange(currentQuestion.id, e.target.value)
              }
              disabled={submitted[currentQuestion.id]}
              className={`mt-2 w-full rounded-md border px-3 py-2 text-sm md:text-base bg-white ${
                isCorrect
                  ? "border-emerald-500 ring-1 ring-emerald-300"
                  : isIncorrect
                  ? "border-rose-500 ring-1 ring-rose-300"
                  : "border-slate-300"
              }`}
              placeholder="Type your answer here"
            />

            {Object.prototype.hasOwnProperty.call(
              results,
              currentQuestion.id
            ) && (
              <div className="text-xs md:text-sm mt-1 space-y-1">
                {isCorrect ? (
                  <div className="text-emerald-600 font-semibold">
                    ✔ Correct
                  </div>
                ) : (
                  <div className="text-rose-600">
                    ✘ Incorrect. One acceptable answer:{" "}
                    <span className="font-semibold">
                      {currentQuestion.answers[0]}
                    </span>
                  </div>
                )}
                <div className="text-slate-700">
                  <span className="font-semibold">Explanation: </span>
                  {currentQuestion.exp}
                </div>
              </div>
            )}
          </div>

          {/* Controls */}
          <div className="flex flex-col md:flex-row items-center justify-between gap-3 mt-4">
            <div className="flex items-center gap-2">
              <button
                onClick={goPrev}
                disabled={currentIndex === 0}
                className={`px-4 py-2 rounded-md text-sm font-semibold shadow-sm transition ${
                  currentIndex === 0
                    ? "bg-slate-300 text-slate-600 cursor-not-allowed"
                    : "bg-slate-200 text-slate-800 hover:bg-slate-300"
                }`}
              >
                Previous
              </button>
              <button
                onClick={goNext}
                disabled={currentIndex === questions.length - 1}
                className={`px-4 py-2 rounded-md text-sm font-semibold shadow-sm transition ${
                  currentIndex === questions.length - 1
                    ? "bg-slate-300 text-slate-600 cursor-not-allowed"
                    : "bg-slate-200 text-slate-800 hover:bg-slate-300"
                }`}
              >
                Next
              </button>
            </div>

            <button
              onClick={handleCheckCurrent}
              disabled={!answerFilled || submitted[currentQuestion.id]}
              className={`px-5 py-2.5 rounded-md text-sm font-semibold text-white shadow-sm transition ${
                !answerFilled || submitted[currentQuestion.id]
                  ? "bg-slate-400 cursor-not-allowed"
                  : "bg-indigo-600 hover:bg-indigo-700"
              }`}
            >
              Check Answer
            </button>
          </div>

          {/* Quiz Summary – only after ALL questions submitted */}
          {allAttempted && (
            <div className="mt-8 border rounded-xl bg-slate-50 p-4 md:p-6">
              <h2 className="text-lg md:text-xl font-semibold text-slate-800 mb-1">
                Quiz Summary
              </h2>
              <p className="text-sm text-slate-600 mb-4">
                Here’s how you did this session.
              </p>

              <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                <div className="bg-white rounded-lg border px-3 py-2 shadow-sm">
                  <div className="text-xs text-slate-500">TOTAL</div>
                  <div className="text-xl font-bold text-slate-800">{total}</div>
                </div>
                <div className="bg-white rounded-lg border px-3 py-2 shadow-sm">
                  <div className="text-xs text-slate-500">ATTEMPTED</div>
                  <div className="text-xl font-bold text-slate-800">
                    {completedCount}
                  </div>
                </div>
                <div className="bg-white rounded-lg border px-3 py-2 shadow-sm">
                  <div className="text-xs text-slate-500">CORRECT</div>
                  <div className="text-xl font-bold text-emerald-600">
                    {correctCount}
                  </div>
                </div>
                <div className="bg-white rounded-lg border px-3 py-2 shadow-sm">
                  <div className="text-xs text-slate-500">INCORRECT</div>
                  <div className="text-xl font-bold text-rose-600">
                    {incorrectCount}
                  </div>
                </div>
                <div className="bg-white rounded-lg border px-3 py-2 shadow-sm">
                  <div className="text-xs text-slate-500">GRADE (%)</div>
                  <div className="text-xl font-bold text-slate-800">
                    {gradePercent}
                  </div>
                </div>
              </div>

              <div className="flex flex-wrap gap-2 mb-4">
                <button
                  disabled
                  className="px-4 py-2 rounded-md text-sm font-semibold border border-slate-300 text-slate-600 bg-white cursor-not-allowed"
                >
                  Review Questions (coming soon)
                </button>
                <button
                  onClick={handleReviewIncorrect}
                  disabled={incorrectCount === 0}
                  className={`px-4 py-2 rounded-md text-sm font-semibold border shadow-sm ${
                    incorrectCount === 0
                      ? "border-rose-200 text-rose-300 bg-white cursor-not-allowed"
                      : "border-rose-300 text-rose-600 bg-white hover:bg-rose-50"
                  }`}
                >
                  Review Incorrect Answers
                </button>
                <button
                  onClick={handleRestartClick}
                  className="px-4 py-2 rounded-md text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm"
                >
                  Restart / Reshuffle
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="min-w-full text-xs md:text-sm text-left">
                  <thead>
                    <tr className="border-b">
                      <th className="py-1 pr-3 font-semibold text-slate-700">
                        Question
                      </th>
                      <th className="py-1 px-3 font-semibold text-slate-700">
                        Result
                      </th>
                      <th className="py-1 px-3 font-semibold text-slate-700">
                        Time Spent
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {questions.map((q, idx) => {
                      const attempted = submitted[q.id];
                      const res = results[q.id];
                      let label = "Not attempted";
                      let color = "text-slate-500";
                      if (attempted && res) {
                        label = "Correct";
                        color = "text-emerald-600";
                      } else if (attempted && !res) {
                        label = "Incorrect";
                        color = "text-rose-600";
                      }
                      const t = timeSpent[q.id];
                      return (
                        <tr key={q.id} className="border-b last:border-0">
                          <td className="py-1 pr-3 align-top">
                            <span className="font-medium">
                              Q{idx + 1}.
                            </span>{" "}
                            <span className="text-slate-700">
                              Page {q.page}, Label {q.label}
                            </span>
                          </td>
                          <td className={`py-1 px-3 align-top ${color}`}>
                            {label}
                          </td>
                          <td className="py-1 px-3 align-top text-slate-700">
                            {attempted ? formatTime(t) : "—"}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ImageOcclusionFitbQuiz />);
  </script>

  <!-- Celebration helper (confetti + streamers + dragon fruit + explosions + text) -->
  <script>
    window.launchConfetti = function (count = 120) {
      try {
        const confettiPieces = count * 2;
        const streamerPieces = count;
        const fruitPieces = 10;

        const colors = [
          "#f97316",
          "#22c55e",
          "#3b82f6",
          "#e11d48",
          "#eab308",
          "#a855f7",
        ];

        // Confetti pieces
        for (let i = 0; i < confettiPieces; i++) {
          const piece = document.createElement("div");
          piece.className = "confetti-piece";
          const left = Math.random() * 100;
          const size = 6 + Math.random() * 6;
          const duration = 2.5 + Math.random() * 1.5;
          const delay = Math.random() * 0.8;
          const rotate = Math.random() * 360;
          const color = colors[Math.floor(Math.random() * colors.length)];

          piece.style.left = left + "%";
          piece.style.width = size + "px";
          piece.style.height = size * 1.6 + "px";
          piece.style.backgroundColor = color;
          piece.style.animationDuration = duration + "s";
          piece.style.animationDelay = delay + "s";
          piece.style.transform = "rotate(" + rotate + "deg)";

          document.body.appendChild(piece);
          piece.addEventListener("animationend", () => {
            if (piece && piece.parentNode) {
              piece.parentNode.removeChild(piece);
            }
          });
        }

        // Streamers
        for (let i = 0; i < streamerPieces; i++) {
          const piece = document.createElement("div");
          piece.className = "streamer-piece";
          const left = Math.random() * 100;
          const size = 45 + Math.random() * 40;
          const duration = 3 + Math.random() * 2;
          const delay = Math.random() * 0.8;
          const rotate = Math.random() * 360;
          const color = colors[Math.floor(Math.random() * colors.length)];

          piece.style.left = left + "%";
          piece.style.width = "5px";
          piece.style.height = size + "px";
          piece.style.backgroundColor = color;
          piece.style.animationDuration = duration + "s";
          piece.style.animationDelay = delay + "s";
          piece.style.transform = "rotate(" + rotate + "deg)";

          document.body.appendChild(piece);
          piece.addEventListener("animationend", () => {
            if (piece && piece.parentNode) {
              piece.parentNode.removeChild(piece);
            }
          });
        }

        // Fruits then explosions + text
        setTimeout(() => {
          for (let i = 0; i < fruitPieces; i++) {
            const piece = document.createElement("div");
            piece.className = "fruit-piece";
            const left = Math.random() * 100;
            const duration = 3.2 + Math.random() * 1.8;
            const delay = Math.random() * 0.4;

            piece.style.left = left + "%";
            piece.style.animationDuration = duration + "s";
            piece.style.animationDelay = delay + "s";

            document.body.appendChild(piece);
            piece.addEventListener("animationend", () => {
              if (piece && piece.parentNode) {
                piece.parentNode.removeChild(piece);
              }
            });
          }

          setTimeout(() => {
            function spawnBoom(delay) {
              setTimeout(() => {
                const boom = document.createElement("div");
                boom.className = "explosion";
                document.body.appendChild(boom);
                boom.addEventListener("animationend", () => boom.remove());
              }, delay);
            }

            spawnBoom(0);
            spawnBoom(300);
            spawnBoom(600);

            // “Hay!” → “Awesome!” → “Amazing!”
            setTimeout(() => {
              const hay = document.createElement("div");
              hay.className = "hay-text";
              hay.textContent = "Hay!";
              document.body.appendChild(hay);

              setTimeout(() => {
                hay.textContent = "Awesome!";
              }, 1200);
              setTimeout(() => {
                hay.textContent = "Amazing!";
              }, 2400);
              setTimeout(() => {
                hay.style.animation = "hay-fade 1s forwards";
              }, 3600);
              setTimeout(() => {
                hay.remove();
              }, 4700);
            }, 600 + 4800);
          }, 1800);
        }, 900);
      } catch (e) {
        console.error("launchConfetti error", e);
      }
    };
  </script>
</body>
</html>
